
<!-- saved from url=(0051)http://csl.yale.edu/~rajit/classes/eeng348/lab3.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>EENG 348/CPSC 338: Digital Systems</title>
<link rel="stylesheet" href="./spec_files/std.css">
<link rel="stylesheet" href="./spec_files/default.css">
<script src="./spec_files/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<style> body { overflow-y: scroll; } </style>
<style> .alttable tr:nth-child(odd) { background: #dfefff; } .alttable tr:nth-child(even) { background: #ffffff; } .alttable { border-spacing: 0 10px; } .alttable td { padding: 5px; } </style>
</head>
<body bgcolor="#ffffff" fgcolor="#000000">
<table width="100%">
<tbody><tr>
<td width="3%">&nbsp;</td>
<td width="94%" align="center"><table width="100%"><tbody><tr><td width="100%"><center>
<table border="0" width="100%">
<tbody><tr>
<td align="right" valign="middle">
<a href="http://csl.yale.edu/"><img src="./spec_files/yaleseas.jpg" height="75" border="0"></a></td>
<td valign="middle" width="80%">
<font face="helvetica,arial">
<center>
<font size="+3">EENG 348/CPSC 338: Digital Systems</font><br><font size="+2">Yale University</font>
</center>
</font></td>
<td align="left" valign="middle">
<a href="http://avlsi.csl.yale.edu/"><img src="./spec_files/anew2.gif" width="150" border="0"></a></td>
</tr>
</tbody></table><br></center>
</td></tr><tr><td width="100%">
<table width="100%"><tbody><tr><td width="90" valign="top"><br>
<table>
<tbody><tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/index.php"><font size="-1">Home</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://www.piazza.com/class"><font size="-1">Discussions</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/lectures.php"><font size="-1">Lectures</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/labs.php"><font size="-1">Labs</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/handouts.php"><font size="-1">Handouts</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/policies.php"><font size="-1">Policies</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://csl.yale.edu/~rajit/classes/eeng348/calendar.php"><font size="-1">Calendar</font></a></b></td></tr>
<tr><td align="right"><b><a href="http://canvas.yale.edu/"><font size="-1">Canvas</font></a></b></td></tr>
</tbody></table>
</td><td width="4">&nbsp;</td><td valign="top"> 
<h3>Lab 3: Analog I/O and Digital I/O protocols</h3>
<b>Due: March 4, 11:59pm. Submit on Canvas.</b><br>
<b>Weight: 10%</b>

<p> The purpose of this lab is to use the AVR microcontroller to
implement analog I/O, and to use digital I/O protocols. The analog
inputs we will use are an ultrasonic range finder and a photocell (a
resistance whose value changes depending on the incident light
intensity), and the analog outputs we will use is an RGB LED. (You'll
need the 10K resistors in the kit) To complete this lab, you will need
to understand analog I/O in addition to completing Lab 2.</p>

<table border="0" cellspacing="4" cellpadding="2" width="100%">
<tbody><tr bgcolor="#aaaacc" valign="center"><td><b>&nbsp; Part 1: Analog voltage input: photocell</b></td>
</tr>
</tbody></table>

<p>
Use the 10K resistor to create a  voltage divider with the photocell. The resistance of the photocell varies depending on the light level.
</p>

<p>Using the <code>analogRead()</code> function that is part of the
Arduino package, read the analog value of the voltage divider. In
comments, explain how you can implement <code>analogRead()</code>
using I/O mapped registers on the AVR (look at the appropriate section
of the datasheet for the AVR). Convert the analog voltage generated by
the voltage divider into an integer value from 0 to 255 (0 = dark, 255
= bright).
</p>

<p>Display the current value once every second using the Serial
interface, and at the same time use this value to set the brightness
of the RGB LED. For this part it is sufficient to simply use a fixed
blue color for the LED. You can use <code>analogWrite()</code>,
which uses PWM output to set the brightness.</p>

<p>
An example that might help you with this part is <a href="https://learn.adafruit.com/photocells/using-a-photocell">here</a>.
</p>

<table border="0" cellspacing="4" cellpadding="2" width="100%">
<tbody><tr bgcolor="#aaaacc" valign="center"><td><b>&nbsp; Part 2: Time-encoded analog value: Ultrasonic range finder</b></td>
</tr>
</tbody></table>

<p>In this part, use the ultrasonic range finder to measure distance
once every second, converting the distance into an integer value 0 to
255 (0 = closest, 255 = farthest away). Use this to change the color
of the LED (closest = green, furthest = red). Combine this with part 1 and use the photocell to set the brightness.</p>

<p>The ultrasonic range finder encodes distance using time. Look at
the data sheet for information about how this works. There are also
<a href="https://www.sparkfun.com/products/13959">examples</a> that
show you how to use the component.</p>

<table border="0" cellspacing="4" cellpadding="2" width="100%">
<tbody><tr bgcolor="#aaaacc" valign="center"><td><b>&nbsp; Part 3: SPI display</b></td>
</tr>
</tbody></table>

<p>
In this part you will use the rotary encoder (uses digital inputs) to control the display of the OLED screen.</p>

<p>
First, make sure you can correctly read the state of the rotary
encoder. For
examples that use the rotary encoder, check out the documents provided
on the web site for the <a href="https://www.sparkfun.com/products/9117">component</a>. Note that you will have to do some simple debouncing on the output of the rotary encoder.</p>

<p> The state of the rotary encoder should be represented as a value
in the range 0 to 255, with one direction of rotation increasing the
value, and the other direction reducing the value. The end points 0
and 255 are saturating---i.e. if you're increasing (decreasing) the
value by rotating the encoder and the value reaches 255 (0), it stays
there until the direction of rotation changes.</p>

<p>
The goal of this part is to draw a bouncing ball on the SPI display. The ball 
should be small (radius 4), and should move around the screen (like one of the original video games: "Pong"). The velocity of the ball should be controlled using the integer value derived from the rotary
encoder. Use integer value 128 to indicate the ball is stationary (velocity = 0), 255 to be the fastest positive velocity, and 0 to be the fastest negative velocity. Pick reasonable values for the maximum velocities and the initial direction the ball will move. The ball should view the edges of the display as a barrier.
</p>

<p><b>Display details:</b>
You can use existing libraries to communicate with the display using SPI. 
In particular, from the Arduino library manager (under Tools&gt;Manage Libraries),
install the Adafruit SSD1306 and GFX libraries.
</p>

<p>
You will need to connect five wires to the digital output pins. The OLED 
screen pins are mapped in the following way:
</p><ul>
<li>CS : this is the chip select signal 
</li><li>DC : this is a mode signal (data/control) used for commands to the SSD1306 controller used by the display
</li><li>RES : reset signal, used for initialization
</li><li>D0 : this is the SPI clock (called <code>CLK</code> below)
</li><li>D1 : this is the SPI data (from the microcontroller to the display, called <code>SI</code> below)
</li><li>VCC : power supply
</li><li>GND : ground
</li></ul>
In what follows, I assume that you have integer constants defined called 
<code>OLED_CS</code>, <code>OLED_DC</code>, <code>OLED_RST</code>,
<code>OLED_SI</code>, <code>OLED_CLK</code> that correspond to the digital
output pins connected to the appropriate signals.
<p></p>

<p>If you have the Adafruit libraries installed, you can communicate with the
display using SPI as follows:
</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Adafruit_SSD1306.h&gt;</span></span>

<span class="hljs-comment">/* 
   #define statements for OLED_CS, OLED_DC, OLED_RST, OLED_SI, OLED_CLK 
   go here.
*/</span>

<span class="hljs-function">Adafruit_SSD1306 <span class="hljs-title">disp</span><span class="hljs-params">(<span class="hljs-number">128</span>,<span class="hljs-number">64</span>,OLED_SI,OLED_CLK,OLED_DC,OLED_RST,OLED_CS)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  disp.begin(SSD1306_SWITCHCAPVCC);
  disp.clearDisplay();
  disp.display();
  disp.drawLine(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, WHITE);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  disp.display();
}

</code></pre>

Check out the <a href="https://learn.adafruit.com/adafruit-gfx-graphics-library/graphics-primitives">documentation</a> for the Adafruit library to see how you can
do different things with the display. Also, go through the source code of the
library on <a href="https://github.com/adafruit/Adafruit_SSD1306">Github</a>
and make sure you understand how the SPI communication actually works.
(FYI, the "Wire" terminology/protocol in the implementation refers to I2C.)
<p></p>

<p>
<b>Extra credit:</b> Implement your own SPI functions to communicate
with the display, as well as your own drawing functions. In other words,
implement this part without using the Adafruit library. 
(Datasheet for the <a href="http://csl.yale.edu/~rajit/classes/eeng348/files/SSD1306.pdf">SSD1306 controller</a>; note
that most of the pins of the controller are not accessible through the OLED
display board, as it is wired up to only export the SPI interface.)
</p>

<table border="0" cellspacing="4" cellpadding="2" width="100%">
<tbody><tr bgcolor="#aaaacc" valign="center"><td><b>&nbsp; What you have to submit</b></td>
</tr>
</tbody></table>

<p>
You should turn in three sketches, one for each part of the lab, as a
single zip file. A simple way to organize this would be to have three
sketches, "sketch_part1", "sketch_part2", "sketch_part3". Please
make sure your program is well-commented. In addition, for each part,
provide a PDF document that includes the circuit schematic that you
used for each part. Please upload one zip file per group.</p>

<p>
For this lab, we want to see a demo of Part 2 and Part 3. You can do this in one of two ways:

</p><ul>
<li>Find either Rajit, or one of the TFs or ULAs, and show them your
demo. In this case, include a file in your zip file called "demo"
that contains text that says "Showed demo to
<i>name-of-person-here</i>" so we know who saw your demo.

</li><li>Alternatively, create a short video (or two videos) that shows
Parts 2 and 3 working, and include it as part of your submission. The
file "demo" should have enough information so we can view your demo
video. If the file isn't huge, you could even include the video as
part of your submission.

</li></ul>


<p></p>


</td></tr></tbody></table></td></tr><tr><td width="100%"><br>
</td></tr></tbody></table></td><td width="3%">&nbsp;</td>
</tr>
</tbody></table><table noborder="" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td>&nbsp;</td><td>&nbsp;</td></tr><tr bgcolor="#00356b"><td width="2%"></td><td width="98%" align="left"><a href="http://www.yale.edu/"><img src="./spec_files/yale-white.png" alt="Yale"></a></td></tr></tbody></table>
</body></html>